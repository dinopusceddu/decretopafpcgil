<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FP CGIL Lombardia - Simulazione Decreto PA</title>
    <!-- Chosen Palette: FP CGIL Lombardia - Rosso primario (#CC0000), Sfondo bianco/grigio chiaro, Testo scuro. Pulsanti di azione principali in rosso. -->
    <!-- Application Structure Plan: Pagina singola con form. Selezione Ente (Lombardia) tramite dropdown Provincia/Comune popolati da JSON esterno (github.io) con fallback a dati locali. Popolazione da JSON. JS calcola soglia % DL34, esegue calcoli finanziari, visualizza risultati. Nuovo campo per dipendenti fondo. Pulsanti Genera PDF (testuale, tabulare), Export CSV, Invia Email (testo). Logo aggiunto. Campi resi obbligatori. Titolo pagina aggiornato. Etichette campi 4 e 5 aggiornate. Rimossa integrazione DB e campi compilatore. Pulsante Calcola. Popup conferma aggiornato. -->
    <!-- Visualization & Content Choices: Input -> Form HTML con selezione Ente da JSON esterno e campo dipendenti. Calcoli -> Logica JS. Output -> Blocco HTML. PDF -> jsPDF generato programmaticamente con testo selezionabile. Export CSV -> JS. Email -> mailto: link con testo semplice. Popolazione da JSON. Popup di conferma. Logo FP CGIL Lombardia. -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. NO DATABASE. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" xintegrity="sha512-BNaRQnYJYiPSqHHDb58B0yaPfCu+Wgds8Gp/gU33kqBtgNS4tSPHuGibyoVBl5gIcgOYDR5ob1硫酸/D98BKVUT41Q==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" xintegrity="sha512-qZvrmS2ekKPF2mSznTQsxqPgnpkI4DNTlrdUmTzrDgektczlKSignRsumbryLDgGTUGBCS3SGGVcTEH3UlDRWA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            background-color: #f0f0f0; 
            color: #333333; 
        }
        .container { 
            background-color: #ffffff; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
            max-width: 800px; 
            margin: 20px auto;
        }
        .logo-container {
            text-align: center;
            margin-bottom: 20px;
        }
        .logo-container img {
            max-width: 250px; 
            height: auto;
        }
        h1 { 
            color: #CC0000; 
            text-align: center; 
            margin-bottom: 20px; 
            font-weight: bold;
        }
        h2 { 
            color: #333333; 
            border-bottom: 2px solid #CC0000; 
            padding-bottom: 10px; 
            margin-top: 30px;
            margin-bottom: 20px;
            font-size: 1.5em;
        }
        h3 { 
            margin-top: 20px; 
            color: #CC0000; 
            font-size: 1.25em;
            margin-bottom: 10px;
        }
         h4 { 
            color: #333333;
            font-size: 1.1em;
            margin-top:15px;
            margin-bottom:10px;
        }
        .letter-intro { 
            font-size: 0.9em; 
            margin-bottom: 20px; 
            line-height: 1.6; 
            background-color: #fee2e2; 
            padding:15px; 
            border-left: 5px solid #CC0000; 
            border-radius: 4px;
        }
        label { 
            display: block; 
            margin-top: 15px; 
            font-weight: bold; 
            color: #444444;
        }
        input[type="text"], input[type="number"], input[type="email"], select, textarea {
            width: calc(100% - 22px); 
            padding: 10px; 
            margin-top: 5px; 
            border: 1px solid #cccccc; 
            border-radius: 4px; 
            box-sizing: border-box;
            background-color: #ffffff;
        }
        input[readonly], select[readonly] {
            background-color: #f0f0f0; 
            cursor: not-allowed;
            color: #555555;
        }
         select:disabled {
            background-color: #e9ecef;
            opacity: 0.7;
        }
        input[type="radio"] { margin-right: 5px; }
        .radio-group label { font-weight: normal; display: inline; margin-right:15px; color: #333333;}
        
        button[type="submit"] { 
            background-color: #CC0000; 
            color: white; 
            padding: 10px 20px; 
            border: none;
            border-radius: 4px; 
            cursor: pointer; 
            font-size: 16px; 
            margin-top: 20px; 
            margin-right: 10px;
            transition: background-color 0.3s;
        }
        button[type="submit"]:hover { 
            background-color: #A30000; 
        }

        .results { 
            margin-top: 30px; 
            padding: 20px; 
            border: 1px solid #dddddd; 
            border-radius: 4px; 
            background-color: #f9f9f9; 
        }
        .results h4 { margin-top:0; color: #CC0000; }
        .error { 
            color: #990000; 
            background-color: #fddede; 
            padding: 10px; 
            border-left: 5px solid #CC0000; 
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .success { 
            color: #006400; 
            background-color: #e6ffed; 
            padding: 10px; 
            border-left: 5px solid #22c55e; 
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .warning { 
            color: #854d0e; 
            background-color: #fffbeb; 
            padding: 10px; 
            border-left: 5px solid #f59e0b; 
            margin-bottom: 10px;
            border-radius: 4px;
        }
        small { font-size: 0.8em; color: #555555; display: block; margin-top: 2px; }
        fieldset { 
            border: 1px solid #dddddd; 
            padding: 20px; 
            margin-bottom: 20px; 
            border-radius: 4px;
        }
        legend { 
            font-weight: bold; 
            color: #CC0000; 
            padding: 0 10px;
            font-size: 1.1em;
        }

        .action-btn { 
            background-color: #CC0000; 
            font-size: 0.9em;
            padding: 8px 12px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
            margin-right: 8px;
            transition: background-color 0.3s;
            display: inline-block;
        }
        .action-btn:hover {
            background-color: #A30000; 
        }
        
        #dataLoadingStatus { 
            background-color: #fffbeb; 
            border: 1px solid #f59e0b; 
            color: #854d0e; 
            padding: 10px;
            text-align: center;
            margin-bottom: 15px;
            border-radius: 4px;
        }
        .calculation-step {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 4px;
            background-color: #f8f8f8; 
            border-left: 4px solid #CC0000; 
        }
         .final-result {
            font-weight: bold;
            font-size: 1.1em;
        }
        .final-result.success strong { 
             color: #006400;
        }
         .final-result.warning strong { 
             color: #854d0e;
        }

        /* Stili per il Modale di Conferma */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000; 
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        .modal-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: center;
            max-width: 450px;
            width: 90%;
        }
        .modal-content p {
            margin-bottom: 20px;
            font-size: 1em;
            line-height: 1.6;
            color: #333;
        }
        .modal-buttons button {
            padding: 10px 20px;
            margin: 0 10px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            transition: background-color 0.2s;
        }
        .modal-confirm-btn {
            background-color: #CC0000; 
            color: white;
        }
        .modal-confirm-btn:hover {
            background-color: #A30000; 
        }
        .modal-cancel-btn {
            background-color: #6c757d; 
            color: white;
        }
        .modal-cancel-btn:hover {
            background-color: #5a6268; 
        }

        @media print {
            body {
                background-color: #fff;
                margin: 20px; 
            }
            .container {
                box-shadow: none;
                border: none;
                padding: 0;
                max-width: 100%;
                margin: 0;
            }
            header > h1, .letter-intro, form, #actionsContainer button:not(.print-btn-placeholder), footer, .no-print, h2:first-of-type, .modal-overlay, .logo-container 
            {
                display: none !important; 
            }
            .results {
                margin-top: 0;
                padding: 0;
                border: none;
                background-color: #fff;
            }
            .results h4 {
                color: #000 !important; 
            }
            .calculation-step {
                border-left: 2px solid #ccc !important;
                background-color: #fff !important;
            }
            .success, .warning, .error {
                border-left-width: 2px !important;
                background-color: #fff !important; 
                color: #000 !important; 
            }
            .final-result.success strong, .final-result.warning strong {
                color: #000 !important;
            }
            a {
                text-decoration: none;
                color: #000 !important;
            }
            #risultatiCalcolo {
                display: block !important;
            }
            h2 { 
                display: none;
            }
            #risultatiCalcolo h4 { 
                 display: block !important;
                 font-size: 1.5em !important; 
                 border-bottom: 2px solid #000 !important;
                 padding-bottom: 5px !important;
                 margin-bottom: 15px !important;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <img src="https://stage.fpcgil.lombardia.it/wp-content/uploads/2019/10/LOGO_LOMBARDIA.png" alt="Logo FP CGIL Lombardia">
        </div>
        <h1>Simulazione incremento potenziale del fondo del salario accessorio</h1>
        <p class="letter-intro">
            Questa applicazione permette di calcolare il potenziale incremento della parte stabile del Fondo risorse decentrate ai sensi dell'art. 14, comma 1-bis, del D.L. 25/2025, considerando i vincoli di capacità assunzionale (D.L. 34/2019 e D.M. 17/03/2020), il tetto di spesa storico (L. 296/06) e l'impatto delle assunzioni previste dal PIAO. La soglia % Spesa Personale / Entrate Correnti è determinata automaticamente in base al numero di abitanti.
        </p>

        <div id="dataLoadingStatus" style="display:none;">Caricamento dati in corso...</div>

        <h2>Modulo Inserimento Dati Ente</h2>
        <form id="calcoloForm">
            <fieldset>
                <legend>Informazioni Ente (Lombardia)</legend>
                <label for="provinciaSelect">Seleziona Provincia (Lombardia):</label>
                <select id="provinciaSelect" name="provinciaSelect" required>
                 <option value="">-- Caricamento Province... --</option>
                </select>

                <label for="comuneSelect">Seleziona Comune:</label>
                <select id="comuneSelect" name="comuneSelect" disabled required>
                <option value="">-- Prima seleziona una Provincia --</option>
                </select>

                <label for="comuneField">Denominazione dell'Ente:</label>
                <input type="text" id="comuneField" name="nome_ente" readonly placeholder="Verrà compilato automaticamente" required />
                
                <label for="popolazioneField">Numero abitanti dell'Ente:</label>
                <input type="number" id="popolazioneField" name="numero_abitanti" readonly placeholder="Verrà compilato automaticamente" required />
                <small>Determina automaticamente la soglia % Spesa Personale / Entrate Correnti.</small>

                <label for="num_dipendenti_fondo_2025">Numero dei dipendenti che attingeranno al fondo nel 2025:</label>
                <input type="number" id="num_dipendenti_fondo_2025" name="num_dipendenti_fondo_2025" placeholder="Es. 50" value="" required>
            </fieldset>
            
            <fieldset>
                <legend>Dati per Calcolo Incremento Fondo (Art. 14 c.1-bis DL 25/2025 - Regola 48%)</legend>
                <label for="stipendi_tabellari_2023">1. Stipendi tabellari del personale in servizio al 31/12/2023:</label>
                <input type="text" id="stipendi_tabellari_2023" name="stipendi_tabellari_2023" placeholder="Es. 583590.50" value="583590.50" required>
                <small>Inclusa 13a mensilità. Usare il punto (.) o la virgola (,) come separatore decimale.</small>

                <label for="componente_stabile_fondo_2023">2. Ammontare somme componente stabile del Fondo ultimo approvato:</label>
                <input type="text" id="componente_stabile_fondo_2023" name="componente_stabile_fondo_2023" placeholder="Es. 69000.00" value="69122.42" required>

                <label for="risorse_po_eq_2023">3. Ammontare somme remunerazione incarichi PO / Elevate Qualificazioni (EQ) ultimo approvato:</label>
                <input type="text" id="risorse_po_eq_2023" name="risorse_po_eq_2023" placeholder="Es. 45000.00" value="44855.00" required>
            </fieldset>

            <fieldset>
                <legend>Dati per Limiti Spesa Personale</legend>
                <label for="spesa_personale_consuntivo">4. Spesa di personale risultante dal consuntivo 2023:</label>
                <input type="text" id="spesa_personale_consuntivo" name="spesa_personale_consuntivo" placeholder="Es. 700000.00" value="720000" required>
                <small>Spesa di personale complessiva al netto degli oneri per rinnovi contrattuali stanziati nell'apposito fondo.</small>

                <label for="entrate_correnti_consuntivo">5. Media triennio 2021-2023 delle Entrate correnti (Titoli I, II, III) al netto del FCDE 2023:</label>
                <input type="text" id="entrate_correnti_consuntivo" name="entrate_correnti_consuntivo" placeholder="Es. 3000000.00" value="3000000" required>

                <label for="soglia_perc_dl34_display">6. Soglia % Spesa Personale / Entrate Correnti (DM 17/3/2020 - Calcolata):</label>
                <input type="text" id="soglia_perc_dl34_display" name="soglia_perc_dl34_display" readonly>
                <small>Calcolata automaticamente in base al numero di abitanti.</small>
                
                <label for="tetto_spesa_c557">7. Tetto di spesa personale art. 1 c. 557 L. 296/06 (media 2011-13):</label>
                <input type="text" id="tetto_spesa_c557" name="tetto_spesa_c557" placeholder="Es. 650000.00" value="900000" required>

                <label for="costo_assunzioni_piao">8. Costo annuo nuove assunzioni previste da ultimo PIAO approvato (a regime):</label>
                <input type="text" id="costo_assunzioni_piao" name="costo_assunzioni_piao" placeholder="Es. 30000.00" value="30000" required>
                <small>Indicare 0 se non previste o già incluse nella spesa di personale a consuntivo.</small>
            </fieldset>
            
            <fieldset>
                <legend>Parametri Aggiuntivi</legend>
                <label for="perc_oneri">9. Percentuale oneri (IRAP e contributi) sull'incremento del fondo:</label>
                <input type="number" id="perc_oneri" name="perc_oneri" placeholder="Es. 33 (per 33%)" value="33" step="0.01" required>
                <small>Percentuale da applicare per calcolare l'incremento netto del fondo dallo spazio lordo disponibile.</small>
            </fieldset>

            <fieldset>
                <legend>Requisiti Normativi Generali (Verifica Preliminare)</legend>
                <label>L'Ente si trova in prima fascia di virtuosità (coerente con la soglia % calcolata)?</label>
                <div class="radio-group">
                    <input type="radio" id="virtuoso_si" name="ente_virtuoso" value="si" checked required> <label for="virtuoso_si">Sì</label>
                    <input type="radio" id="virtuoso_no" name="ente_virtuoso" value="no"> <label for="virtuoso_no">No</label>
                </div>
                <small>Questa è una verifica qualitativa; il calcolo dello spazio DL34 userà la soglia % calcolata automaticamente.</small>

                <label>L'Ente rispetta i limiti di spesa del personale (art. 1, c. 557 & 562, L. 296/2006) al netto di questo potenziale incremento?</label>
                 <div class="radio-group">
                    <input type="radio" id="limiti_si" name="rispetto_limiti_spesa_generale" value="si" checked required> <label for="limiti_si_generale">Sì</label>
                    <input type="radio" id="limiti_no" name="rispetto_limiti_spesa_generale" value="no"> <label for="limiti_no_generale">No</label>
                </div>
                <small>Questa è una verifica qualitativa; il calcolo del margine c.557 userà i dati numerici.</small>


                <label>L'Ente ha l'equilibrio pluriennale di bilancio asseverato dall'organo di revisione?</label>
                <div class="radio-group">
                    <input type="radio" id="equilibrio_si" name="equilibrio_bilancio" value="si" checked required> <label for="equilibrio_si">Sì</label>
                    <input type="radio" id="equilibrio_no" name="equilibrio_bilancio" value="no"> <label for="equilibrio_no">No</label>
                </div>
            </fieldset>

            <button type="submit">Calcola</button>
        </form>

        <div id="risultatiCalcolo" class="results" style="display:none;">
            </div>
    </div>

     <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <p>Verifica la correttezza dei dati inseriti e conferma per procedere con il calcolo. Potrai poi esportare o inviare i risultati.</p>
            <div class="modal-buttons">
                <button id="modalConfirmBtn" class="modal-confirm-btn">Continua e Calcola</button>
                <button id="modalCancelBtn" class="modal-cancel-btn">Annulla</button>
            </div>
        </div>
    </div>

    <script>
        let datiPerReport = {}; 
        let datiOriginaliInput = {}; 
        let comuniDataGlobal = []; 

        // CAMPIONE DATI LOMBARDIA (dalla struttura fornita)
        const comuniDataGlobalSample = [
            {"istat": "012001", "comune": "Agra", "regione": "Lombardia", "provincia": "VA", "num_residenti": 403},
            {"istat": "012002", "comune": "Albizzate", "regione": "Lombardia", "provincia": "VA", "num_residenti": 5145},
            {"istat": "012003", "comune": "Angera", "regione": "Lombardia", "provincia": "VA", "num_residenti": 5391},
            {"istat": "016001", "comune": "Adrara San Martino", "regione": "Lombardia", "provincia": "BG", "num_residenti": 2184},
            {"istat": "016002", "comune": "Adrara San Rocco", "regione": "Lombardia", "provincia": "BG", "num_residenti": 808},
            {"istat": "016243", "comune": "Vilminore di Scalve", "regione": "Lombardia", "provincia": "BG", "num_residenti": 1433},
            {"istat": "015146", "comune": "Milano", "regione": "Lombardia", "provincia": "MI", "num_residenti": 1371498},
            {"istat": "017003", "comune": "Agnosine", "regione": "Lombardia", "provincia": "BS", "num_residenti": 1647},
            {"istat": "013003", "comune": "Albavilla", "regione": "Lombardia", "provincia": "CO", "num_residenti": 6371},
            {"istat": "019001", "comune": "Acquanegra Cremonese", "regione": "Lombardia", "provincia": "CR", "num_residenti": 1123},
            {"istat": "097001", "comune": "Abbadia Lariana", "regione": "Lombardia", "provincia": "LC", "num_residenti": 3203},
            {"istat": "098032", "comune": "Lodi", "regione": "Lombardia", "provincia": "LO", "num_residenti": 44709},
            {"istat": "020016", "comune": "Castellucchio", "regione": "Lombardia", "provincia": "MN", "num_residenti": 5176},
            {"istat": "108001", "comune": "Agrate Brianza", "regione": "Lombardia", "provincia": "MB", "num_residenti": 15547},
            {"istat": "018001", "comune": "Alagna", "regione": "Lombardia", "provincia": "PV", "num_residenti": 756},
            {"istat": "014001", "comune": "Albaredo per San Marco", "regione": "Lombardia", "provincia": "SO", "num_residenti": 296}
        ];

        function getSogliaPercentualeDL34(abitanti) {
            if (abitanti < 1000) return 0.2950;
            if (abitanti <= 1999) return 0.2860;
            if (abitanti <= 2999) return 0.2760;
            if (abitanti <= 4999) return 0.2720;
            if (abitanti <= 9999) return 0.2690;
            if (abitanti <= 59999) return 0.2700;
            if (abitanti <= 249999) return 0.2760;
            if (abitanti <= 1499999) return 0.2880;
            return 0.2530;
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            const selProv = document.getElementById('provinciaSelect');
            const selCom = document.getElementById('comuneSelect');
            const fldNome = document.getElementById('comuneField');
            const fldPop  = document.getElementById('popolazioneField');
            const sogliaDisplay = document.getElementById('soglia_perc_dl34_display');
            const dataLoadingStatusDiv = document.getElementById('dataLoadingStatus');
            const modalOverlay = document.getElementById('confirmationModal');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');

            dataLoadingStatusDiv.style.display = 'block';
            dataLoadingStatusDiv.textContent = 'Caricamento dati comuni della Lombardia...';

            try {
                const response = await fetch('https://dinopusceddu.github.io/comunilombardi/italy_cities.json');
                if (!response.ok) {
                    console.warn(`Errore HTTP nel caricare i comuni: ${response.status} - ${response.statusText}. Utilizzo dati di fallback incorporati.`);
                    comuniDataGlobal = comuniDataGlobalSample; 
                    dataLoadingStatusDiv.innerHTML = 'Errore caricamento dati esterni. <br>Utilizzo dati di esempio locali (Lombardia).';
                    dataLoadingStatusDiv.style.color = 'orange'; 
                } else {
                    const jsonData = await response.json();
                    comuniDataGlobal = jsonData.Foglio1 || jsonData; 
                    dataLoadingStatusDiv.textContent = 'Dati comuni caricati con successo dal server.';
                     setTimeout(() => { dataLoadingStatusDiv.style.display = 'none'; }, 1500);
                }
                
                if (!Array.isArray(comuniDataGlobal) || comuniDataGlobal.length === 0) {
                    console.error("Nessun dato comune valido disponibile (né da fetch né da fallback):", comuniDataGlobal);
                    if (!Array.isArray(comuniDataGlobalSample) || comuniDataGlobalSample.length === 0) {
                        throw new Error("Nessun dato comune valido disponibile, neanche nel campione locale.");
                    }
                    console.warn("Utilizzo del campione di dati locale perché i dati caricati non sono validi.");
                    comuniDataGlobal = comuniDataGlobalSample;
                    if (dataLoadingStatusDiv.style.color !== 'orange') { 
                        dataLoadingStatusDiv.textContent = 'Utilizzo dati di esempio locali (caricamento fallito o dati non validi).';
                        dataLoadingStatusDiv.style.color = 'orange';
                    }
                }

                const comuniLombardia = comuniDataGlobal.filter(comune => comune.regione === "Lombardia");
                
                const provinceLombardiaMap = new Map();
                comuniLombardia.forEach(comune => {
                    const siglaProvincia = (typeof comune.provincia === 'string') ? comune.provincia.trim() : null;
                    const nomeProvinciaVisualizzato = siglaProvincia; 

                    if (siglaProvincia && !provinceLombardiaMap.has(siglaProvincia)) {
                        provinceLombardiaMap.set(siglaProvincia, nomeProvinciaVisualizzato); 
                    }
                });

                const provinceLombardiaUniche = Array.from(provinceLombardiaMap.entries())
                                                     .map(([sigla, nome]) => ({ sigla, nome })) 
                                                     .sort((a,b) => (a.nome || '').localeCompare(b.nome || ''));

                selProv.innerHTML = '<option value="">-- Seleziona una Provincia --</option>'; 
                provinceLombardiaUniche.forEach(p => {
                    const option = new Option(p.nome, p.sigla); 
                    selProv.appendChild(option);
                });
                
                if (dataLoadingStatusDiv.style.color !== 'red' && dataLoadingStatusDiv.style.color !== 'orange') {
                     setTimeout(() => { dataLoadingStatusDiv.style.display = 'none'; }, 500);
                } else if (dataLoadingStatusDiv.style.color === 'orange') { 
                    setTimeout(() => { dataLoadingStatusDiv.style.display = 'none'; }, 3000);
                }


            } catch (error) { 
                console.error("Errore caricamento o processamento dati comuni:", error);
                dataLoadingStatusDiv.textContent = `Errore caricamento/elaborazione elenco comuni: ${error.message}. Utilizzo dati di esempio locali.`;
                dataLoadingStatusDiv.style.color = 'red';
                comuniDataGlobal = comuniDataGlobalSample; 
                
                const comuniLombardiaSampleFallback = comuniDataGlobal.filter(comune => comune.regione === "Lombardia");
                const provinceLombardiaMapSample = new Map();
                comuniLombardiaSampleFallback.forEach(comune => {
                    const siglaProvincia = (typeof comune.provincia === 'string') ? comune.provincia.trim() : null;
                    const nomeProvinciaVisualizzato = siglaProvincia;
                    if (siglaProvincia && !provinceLombardiaMapSample.has(siglaProvincia)) {
                        provinceLombardiaMapSample.set(siglaProvincia, nomeProvinciaVisualizzato);
                    }
                });
                const provinceLombardiaUnicheSample = Array.from(provinceLombardiaMapSample.entries())
                                                     .map(([sigla, nome]) => ({ sigla, nome }))
                                                     .sort((a,b) => (a.nome || '').localeCompare(b.nome || ''));
                selProv.innerHTML = '<option value="">-- Seleziona una Provincia (Esempio) --</option>';
                provinceLombardiaUnicheSample.forEach(p => {
                    const option = new Option(p.nome, p.sigla);
                    selProv.appendChild(option);
                });
            }

            selProv.addEventListener('change', () => {
                const siglaProvinciaSelezionata = selProv.value; 

                selCom.disabled = true;
                selCom.innerHTML = `<option value="" disabled selected>Caricamento comuni...</option>`;
                fldNome.value = '';
                fldPop.value = '';
                sogliaDisplay.value = '';
                
                if (!siglaProvinciaSelezionata) { 
                    selCom.disabled = true;
                    return;
                }

                const comuniFiltrati = comuniDataGlobal.filter(c => 
                    c.regione === "Lombardia" && 
                    c.provincia === siglaProvinciaSelezionata 
                ).sort((a, b) => (a.comune || '').localeCompare(b.comune || ''));
                
                selCom.innerHTML = `<option value="">-- Seleziona un Comune --</option>`;
                if (comuniFiltrati.length > 0) {
                    comuniFiltrati.forEach(c => { 
                        const nomeComune = c.comune; 
                        const codiceComune = String(c.istat); 
                        const popolazioneComune = c.num_residenti; 

                        if (nomeComune && codiceComune) {
                             const option = new Option(nomeComune, codiceComune); 
                             option.dataset.popolazione = popolazioneComune || 'N/D';
                             selCom.appendChild(option);
                        }
                    });
                    selCom.disabled = false;
                } else {
                    selCom.innerHTML = `<option value="">Nessun comune trovato</option>`;
                }
            });

            selCom.addEventListener('change', () => {
                const codiceISTATComune = selCom.value; 
                const selectedOption = selCom.options[selCom.selectedIndex];
                const nomeComune = selectedOption.text; 
                
                fldNome.value = `Comune di ${nomeComune}`;
                
                if (!codiceISTATComune) {
                    fldPop.value = '';
                    sogliaDisplay.value = '';
                    return;
                }
                
                const popolazione = selectedOption.dataset.popolazione;
                fldPop.value = popolazione !== 'N/D' ? popolazione : '';

                if (popolazione !== 'N/D' && !isNaN(parseInt(popolazione))) {
                    const soglia = getSogliaPercentualeDL34(parseInt(popolazione, 10));
                    sogliaDisplay.value = (soglia * 100).toFixed(2) + '%';
                } else {
                    sogliaDisplay.value = 'N/D (pop. mancante)';
                }
            });

            // Gestione Modale
            modalConfirmBtn.addEventListener('click', () => {
                modalOverlay.classList.remove('active');
                procediConCalcolo(); 
            });

            modalCancelBtn.addEventListener('click', () => {
                modalOverlay.classList.remove('active');
            });
        });

        function procediConCalcolo() { 
            datiOriginaliInput.nome_ente = document.getElementById('comuneField').value.trim(); 
            datiOriginaliInput.numero_abitanti = parseInt(document.getElementById('popolazioneField').value, 10); 
            datiOriginaliInput.num_dipendenti_fondo_2025 = parseInt(document.getElementById('num_dipendenti_fondo_2025').value, 10) || 0;
            datiOriginaliInput.stipendi_tabellari_2023_str = document.getElementById('stipendi_tabellari_2023').value;
            datiOriginaliInput.componente_stabile_fondo_2023_str = document.getElementById('componente_stabile_fondo_2023').value;
            datiOriginaliInput.risorse_po_eq_2023_str = document.getElementById('risorse_po_eq_2023').value;
            datiOriginaliInput.spesa_personale_consuntivo_str = document.getElementById('spesa_personale_consuntivo').value;
            datiOriginaliInput.entrate_correnti_consuntivo_str = document.getElementById('entrate_correnti_consuntivo').value;
            datiOriginaliInput.tetto_spesa_c557_str = document.getElementById('tetto_spesa_c557').value;
            datiOriginaliInput.costo_assunzioni_piao_str = document.getElementById('costo_assunzioni_piao').value;
            datiOriginaliInput.perc_oneri_str = document.getElementById('perc_oneri').value;
            datiOriginaliInput.ente_virtuoso_check = document.querySelector('input[name="ente_virtuoso"]:checked').value;
            datiOriginaliInput.rispetto_limiti_spesa_generale_check = document.querySelector('input[name="rispetto_limiti_spesa_generale"]:checked').value;
            datiOriginaliInput.equilibrio_bilancio_check = document.querySelector('input[name="equilibrio_bilancio"]:checked').value;

            const risultatiDiv = document.getElementById('risultatiCalcolo');
            risultatiDiv.innerHTML = ''; 
            risultatiDiv.style.display = 'block';

            function parseNumericValue(valueStr) {
                if (valueStr === null || valueStr === undefined || typeof valueStr !== 'string' && typeof valueStr !== 'number' ) return NaN;
                const cleanedStr = String(valueStr).replace(/\s/g, '').replace(',', '.'); 
                const num = parseFloat(cleanedStr);
                return isNaN(num) ? NaN : num;
            }

            const stipendiTabellari2023 = parseNumericValue(datiOriginaliInput.stipendi_tabellari_2023_str);
            const componenteStabileFondo2023 = parseNumericValue(datiOriginaliInput.componente_stabile_fondo_2023_str);
            const risorsePoEq2023 = parseNumericValue(datiOriginaliInput.risorse_po_eq_2023_str);
            const spesaPersonaleConsuntivo = parseNumericValue(datiOriginaliInput.spesa_personale_consuntivo_str);
            const entrateCorrentiConsuntivo = parseNumericValue(datiOriginaliInput.entrate_correnti_consuntivo_str);
            
            const numeroAbitanti = datiOriginaliInput.numero_abitanti;
            if (isNaN(numeroAbitanti) || numeroAbitanti <= 0) {
                risultatiDiv.innerHTML = '<p class="error">Errore: Numero di abitanti non valido. Selezionare Provincia e Comune.</p>';
                return;
            }
            const sogliaPercDL34 = getSogliaPercentualeDL34(numeroAbitanti);
             const sogliaDisplayInput = document.getElementById('soglia_perc_dl34_display');
            if(sogliaDisplayInput) sogliaDisplayInput.value = (sogliaPercDL34 * 100).toFixed(2) + '%';


            const tettoSpesaC557 = parseNumericValue(datiOriginaliInput.tetto_spesa_c557_str);
            const costoAssunzioniPIAO = parseNumericValue(datiOriginaliInput.costo_assunzioni_piao_str);
            const percOneri = parseNumericValue(datiOriginaliInput.perc_oneri_str) / 100; 
            
            const numericInputs = [stipendiTabellari2023, componenteStabileFondo2023, risorsePoEq2023, spesaPersonaleConsuntivo, entrateCorrentiConsuntivo, sogliaPercDL34, tettoSpesaC557, costoAssunzioniPIAO, percOneri];
            if (numericInputs.some(isNaN)) {
                risultatiDiv.innerHTML = '<p class="error">Errore: Assicurarsi che tutti i campi numerici siano compilati correttamente.</p>';
                return;
            }
             if (stipendiTabellari2023 <= 0 || entrateCorrentiConsuntivo <=0 || sogliaPercDL34 <=0 || tettoSpesaC557 <0 || spesaPersonaleConsuntivo < 0 || costoAssunzioniPIAO < 0 || percOneri < 0) {
                 risultatiDiv.innerHTML = '<p class="error">Errore: Controllare i valori inseriti. Stipendi 2023, Entrate Correnti e Soglia % DL34 devono essere > 0. Altri valori numerici non possono essere negativi.</p>';
                return;
            }

            const formatCurrency = (num) => num.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' });
            const formatPercentage = (num) => (num * 100).toFixed(2) + '%';

            let messaggio_risultato = `<h4>Risultati del Calcolo Dettagliato per: ${datiOriginaliInput.nome_ente || 'N/D'}</h4>`;
            messaggio_risultato += `<div class="calculation-step"><p>Numero Abitanti Utilizzato: ${numeroAbitanti.toLocaleString('it-IT')}</p></div>`;
            
            messaggio_risultato += `<h3>Fase 1: Incremento Potenziale Massimo (Regola del 48%)</h3>`;
            const sommaFondoEQ2023 = componenteStabileFondo2023 + risorsePoEq2023;
            const target48Stipendi2023 = stipendiTabellari2023 * 0.48;
            const incrementoPotenziale48 = Math.max(0, target48Stipendi2023 - sommaFondoEQ2023);
            messaggio_risultato += `<div class="calculation-step"><p>Stipendi Tabellari 2023: ${formatCurrency(stipendiTabellari2023)}</p></div>`;
            messaggio_risultato += `<div class="calculation-step"><p>Somma Fondo Stabile 2023 + Risorse PO/EQ 2023: ${formatCurrency(sommaFondoEQ2023)}</p></div>`;
            messaggio_risultato += `<div class="calculation-step"><p>Obiettivo 48% degli Stipendi Tabellari 2023: ${formatCurrency(target48Stipendi2023)}</p></div>`;
            messaggio_risultato += `<div class="calculation-step final-result"><p>Incremento Potenziale Lordo (Regola 48%): ${formatCurrency(incrementoPotenziale48)}</p></div>`;

            messaggio_risultato += `<h3>Fase 2: Verifica Limite Capacità Assunzionale (DL 34/2019 e DM 17/3/2020)</h3>`;
            const spesaPersonaleAttualePIAO = spesaPersonaleConsuntivo + costoAssunzioniPIAO;
            const limiteSpesaPersonaleDL34 = entrateCorrentiConsuntivo * sogliaPercDL34;
            const spazioDisponibileDL34 = Math.max(0, limiteSpesaPersonaleDL34 - spesaPersonaleAttualePIAO);
            messaggio_risultato += `<div class="calculation-step"><p>Spesa Personale Consuntivo: ${formatCurrency(spesaPersonaleConsuntivo)}</p></div>`;
            messaggio_risultato += `<div class="calculation-step"><p>Costo Assunzioni PIAO: ${formatCurrency(costoAssunzioniPIAO)}</p></div>`;
            messaggio_risultato += `<div class="calculation-step"><p>Spesa Personale Attuale (inclusa PIAO): ${formatCurrency(spesaPersonaleAttualePIAO)}</p></div>`;
            messaggio_risultato += `<div class="calculation-step"><p>Entrate Correnti Consuntivo: ${formatCurrency(entrateCorrentiConsuntivo)}</p></div>`;
            messaggio_risultato += `<div class="calculation-step"><p>Soglia % Spesa Personale / Entrate Correnti (DM 17/3/2020 - Calcolata per ${numeroAbitanti.toLocaleString('it-IT')} abitanti): ${formatPercentage(sogliaPercDL34)}</p></div>`;
            messaggio_risultato += `<div class="calculation-step"><p>Limite Spesa Personale Sostenibile (DL34): ${formatCurrency(limiteSpesaPersonaleDL34)}</p></div>`;
            messaggio_risultato += `<div class="calculation-step final-result"><p>Spazio Disponibile per Ulteriore Spesa (Limite DL34): ${formatCurrency(spazioDisponibileDL34)}</p></div>`;

            messaggio_risultato += `<h3>Fase 3: Verifica Limite Tetto Storico (L. 296/06 c.557)</h3>`;
            const margineDisponibileC557 = Math.max(0, tettoSpesaC557 - spesaPersonaleAttualePIAO);
            messaggio_risultato += `<div class="calculation-step"><p>Tetto Spesa Personale (c.557 media 2011-13): ${formatCurrency(tettoSpesaC557)}</p></div>`;
            messaggio_risultato += `<div class="calculation-step"><p>Spesa Personale Attuale (inclusa PIAO): ${formatCurrency(spesaPersonaleAttualePIAO)}</p></div>`;
            messaggio_risultato += `<div class="calculation-step final-result"><p>Margine Disponibile per Ulteriore Spesa (Limite c.557): ${formatCurrency(margineDisponibileC557)}</p></div>`;

            messaggio_risultato += `<h3>Fase 4: Determinazione Spazio Utilizzabile Lordo per Incremento Fondo</h3>`;
            const spazioUtilizzabileLordo = Math.min(incrementoPotenziale48, spazioDisponibileDL34, margineDisponibileC557);
            messaggio_risultato += `<div class="calculation-step final-result"><p>Spazio Utilizzabile Lordo (min tra potenziale 48%, spazio DL34, margine c.557): ${formatCurrency(spazioUtilizzabileLordo)}</p></div>`;

            messaggio_risultato += `<h3>Fase 5: Calcolo Incremento Netto Effettivo del Fondo</h3>`;
            const incrementoNettoFondo = spazioUtilizzabileLordo / (1 + percOneri);
            messaggio_risultato += `<div class="calculation-step"><p>Percentuale Oneri (IRAP, Contributi): ${formatPercentage(percOneri)}</p></div>`;
            messaggio_risultato += `<div class="calculation-step final-result success"><strong>Incremento Netto Effettivo del Fondo: ${formatCurrency(incrementoNettoFondo)}</strong></div>`;
            
            messaggio_risultato += `<h3>Verifica Condizioni Normative Generali:</h3>`;
            let note_condizioni_html = "<ul>";
            let incremento_finale_applicabile = true;

            if (datiOriginaliInput.ente_virtuoso_check === 'no') {
                note_condizioni_html += "<li>Verifica qualitativa: Ente NON indicato como in prima fascia di virtuosità. Prerequisito fondamentale (DL 25/2025).</li>";
                 incremento_finale_applicabile = false;
            } else {
                 note_condizioni_html += "<li>Verifica qualitativa: Ente indicato como in prima fascia di virtuosità: OK.</li>";
            }

            if (datiOriginaliInput.rispetto_limiti_spesa_generale_check === 'no') {
                note_condizioni_html += "<li>Verifica qualitativa: Ente NON rispetta i limiti generali di spesa del personale (L. 296/2006). Vincolo stringente.</li>";
                incremento_finale_applicabile = false; 
            } else {
                note_condizioni_html += "<li>Verifica qualitativa: Ente rispetta i limiti generali di spesa del personale: OK.</li>";
            }

            if (datiOriginaliInput.equilibrio_bilancio_check === 'no') {
                note_condizioni_html += "<li>Verifica qualitativa: Ente NON ha l'equilibrio pluriennale di bilancio asseverato. Condizione necessaria.</li>";
                incremento_finale_applicabile = false; 
            } else {
                note_condizioni_html += "<li>Verifica qualitativa: Ente ha l'equilibrio pluriennale di bilancio asseverato: OK.</li>";
            }
            note_condizioni_html += "</ul>";
            messaggio_risultato += note_condizioni_html;

            if (!incremento_finale_applicabile && incrementoNettoFondo > 0) {
                 messaggio_risultato += `<p class='warning'><strong>ATTENZIONE: Nonostante un incremento netto positivo (${formatCurrency(incrementoNettoFondo)}), alcune condizioni generali dichiarate NON rispettate potrebbero precludere l'applicazione. Verificare.</strong></p>`;
            } else if (incrementoNettoFondo <= 0) {
                 messaggio_risultato += `<p class='warning'>Non ci sono margini per un incremento netto del fondo.</p>`;
            }
            
            messaggio_risultato += `<p><em>Nota: L'incremento del Fondo è una spesa di personale...</em></p>`;
            
            datiPerReport = { 
                nome_ente_calcolo: datiOriginaliInput.nome_ente, 
                numero_abitanti_calcolo: numeroAbitanti,
                provincia_selezionata: document.getElementById('provinciaSelect').value, 
                comune_selezionato: datiOriginaliInput.nome_ente.replace('Comune di ',''), 
                num_dipendenti_fondo_2025: datiOriginaliInput.num_dipendenti_fondo_2025,
                input_stipendi_tabellari_2023: stipendiTabellari2023,
                input_componente_stabile_fondo_2023: componenteStabileFondo2023,
                input_risorse_po_eq_2023: risorsePoEq2023,
                input_spesa_personale_consuntivo: spesaPersonaleConsuntivo,
                input_entrate_correnti_consuntivo: entrateCorrentiConsuntivo,
                input_soglia_perc_dl34_calcolata: (sogliaPercDL34 * 100).toFixed(2) + '%',
                input_tetto_spesa_c557: tettoSpesaC557,
                input_costo_assunzioni_piao: costoAssunzioniPIAO,
                input_perc_oneri_incremento: percOneri,
                check_ente_virtuoso: datiOriginaliInput.ente_virtuoso_check,
                check_rispetto_limiti_spesa_generale: datiOriginaliInput.rispetto_limiti_spesa_generale_check,
                check_equilibrio_bilancio: datiOriginaliInput.equilibrio_bilancio_check,
                calc_incremento_potenziale_48: incrementoPotenziale48,
                calc_spazio_disponibile_dl34: spazioDisponibileDL34,
                calc_margine_disponibile_c557: margineDisponibileC557,
                calc_spazio_utilizzabile_lordo: spazioUtilizzabileLordo,
                calc_incremento_netto_fondo: incrementoNettoFondo,
                calc_incremento_finale_applicabile: incremento_finale_applicabile ? "Sì" : "No"
            };

            messaggio_risultato += `<div id="actionsContainer" class="mt-6 pt-4 border-t border-gray-300"> 
                                        <h4>Azioni Aggiuntive</h4>
                                        <button type="button" id="btnPrintResults" class="action-btn">📄 Genera Report PDF</button>
                                        <button type="button" id="btnExportCsv" class="action-btn">📊 Esporta in CSV (per Excel)</button>
                                        <button type="button" id="btnInviaEmail" class="action-btn">📧 Invia Report via Email</button>
                                    </div>`;
            
            risultatiDiv.innerHTML = messaggio_risultato;
            setupActionListeners(); 
        }

        document.getElementById('calcoloForm').addEventListener('submit', function(event) { 
            event.preventDefault();
            procediConCalcolo();
        });


        function setupActionListeners() {
            const btnPrint = document.getElementById('btnPrintResults');
            if(btnPrint) btnPrint.addEventListener('click', handleGeneratePDF); 

            const btnCsv = document.getElementById('btnExportCsv');
            if(btnCsv) btnCsv.addEventListener('click', handleExportToCSV);

            const btnEmail = document.getElementById('btnInviaEmail');
            if(btnEmail) btnEmail.addEventListener('click', handleInviaEmail);
        }

        function handleGeneratePDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ orientation: 'p', unit: 'mm', format: 'a4' });
            const dataLoadingStatusDiv = document.getElementById('dataLoadingStatus');

            if (!datiPerReport || Object.keys(datiPerReport).length === 0) {
                alert("Nessun dato da esportare in PDF. Effettuare prima un calcolo.");
                return;
            }
            if (dataLoadingStatusDiv) {
                dataLoadingStatusDiv.innerHTML = "<p>Generazione PDF in corso... attendere prego.</p>";
                dataLoadingStatusDiv.style.display = 'block';
            }

            const lineHeight = 7;
            const margin = 15;
            let yPosition = margin;
            const pageHeight = doc.internal.pageSize.getHeight();
            const pageWidth = doc.internal.pageSize.getWidth();
            const usableWidth = pageWidth - (2 * margin);
            const labelWidth = usableWidth * 0.55; 
            const valueWidth = usableWidth * 0.45; 
            const valueXOffset = margin + labelWidth; 

            const formatCurrencyPDF = (num) => typeof num === 'number' ? num.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' }) : (num || 'N/D');
            const formatPercentagePDF = (num) => typeof num === 'number' ? (num * 100).toFixed(2) + '%' : (num || 'N/D');
            const formatNumberPDF = (num) => typeof num === 'number' ? num.toLocaleString('it-IT') : (num || 'N/D');


            function checkPageBreak(neededHeight = lineHeight) {
                if (yPosition + neededHeight > pageHeight - margin) {
                    doc.addPage();
                    yPosition = margin;
                }
            }

            function addSectionTitle(title) {
                checkPageBreak(lineHeight * 2); 
                doc.setFontSize(14);
                doc.setFont(undefined, 'bold');
                doc.text(title, margin, yPosition);
                yPosition += lineHeight * 1.5;
                doc.setFontSize(10); 
                doc.setFont(undefined, 'normal');
            }
            
            function addDataRow(label, value, isBoldValue = false) {
                checkPageBreak(lineHeight * Math.max(doc.splitTextToSize(label, labelWidth).length, doc.splitTextToSize(String(value), valueWidth).length));
                
                doc.setFont(undefined, 'bold');
                doc.text(label, margin, yPosition, {maxWidth: labelWidth});
                
                const labelLines = doc.splitTextToSize(label, labelWidth).length;
                
                doc.setFont(undefined, isBoldValue ? 'bold' : 'normal');
                doc.text(String(value), valueXOffset, yPosition, {maxWidth: valueWidth});
                
                const valueLines = doc.splitTextToSize(String(value), valueWidth).length;
                yPosition += lineHeight * Math.max(labelLines, valueLines);
            }
             function addListItem(text) {
                checkPageBreak();
                doc.text(`- ${text}`, margin + 5, yPosition);
                yPosition += lineHeight;
            }

            doc.setFontSize(18);
            doc.setFont(undefined, 'bold');
            doc.text("Report Calcolo Incremento Fondo", pageWidth / 2, yPosition, { align: 'center' });
            yPosition += lineHeight * 2;
            doc.setFontSize(10);
            doc.setFont(undefined, 'normal');

            addSectionTitle("Dati Ente"); 
            addDataRow("Denominazione Ente:", datiPerReport.nome_ente_calcolo);
            addDataRow("Numero Abitanti:", formatNumberPDF(datiPerReport.numero_abitanti_calcolo));
            addDataRow("Provincia Selezionata:", datiPerReport.provincia_selezionata);
            addDataRow("Comune Selezionato:", datiPerReport.comune_selezionato);
            addDataRow("Numero Dipendenti Fondo 2025:", formatNumberPDF(datiPerReport.num_dipendenti_fondo_2025));
            
            addSectionTitle("Dati di Input");
            addDataRow("1. Stipendi tabellari 2023:", formatCurrencyPDF(datiPerReport.input_stipendi_tabellari_2023));
            addDataRow("2. Componente stabile Fondo ultimo approvato:", formatCurrencyPDF(datiPerReport.input_componente_stabile_fondo_2023));
            addDataRow("3. Risorse PO/EQ ultimo approvato:", formatCurrencyPDF(datiPerReport.input_risorse_po_eq_2023));
            addDataRow("4. Spesa di personale risultante dal consuntivo 2023:", formatCurrencyPDF(datiPerReport.input_spesa_personale_consuntivo));
            addDataRow("5. Media triennio 2021-2023 delle Entrate correnti (Titoli I, II, III) al netto del FCDE 2023:", formatCurrencyPDF(datiPerReport.input_entrate_correnti_consuntivo));
            addDataRow("6. Soglia % Spesa/Entrate (DM 17/3/2020):", datiPerReport.input_soglia_perc_dl34_calcolata);
            addDataRow("7. Tetto spesa personale (c.557 L.296/06):", formatCurrencyPDF(datiPerReport.input_tetto_spesa_c557));
            addDataRow("8. Costo annuo nuove assunzioni PIAO:", formatCurrencyPDF(datiPerReport.input_costo_assunzioni_piao));
            addDataRow("9. % Oneri su incremento fondo:", formatPercentagePDF(datiPerReport.input_perc_oneri_incremento));
            
            addSectionTitle("Risultati del Calcolo");
            checkPageBreak(lineHeight); doc.setFont(undefined, 'bold'); doc.text("Fase 1: Incremento Potenziale Massimo (Regola del 48%)", margin, yPosition); yPosition += lineHeight; doc.setFont(undefined, 'normal');
            addDataRow("Incremento Potenziale Lordo:", formatCurrencyPDF(datiPerReport.calc_incremento_potenziale_48));
            checkPageBreak(lineHeight); doc.setFont(undefined, 'bold'); doc.text("Fase 2: Verifica Limite Capacità Assunzionale (DL 34/2019)", margin, yPosition); yPosition += lineHeight; doc.setFont(undefined, 'normal');
            addDataRow("Spazio Disponibile (Limite DL34):", formatCurrencyPDF(datiPerReport.calc_spazio_disponibile_dl34));
            checkPageBreak(lineHeight); doc.setFont(undefined, 'bold'); doc.text("Fase 3: Verifica Limite Tetto Storico (L. 296/06 c.557)", margin, yPosition); yPosition += lineHeight; doc.setFont(undefined, 'normal');
            addDataRow("Margine Disponibile (Limite c.557):", formatCurrencyPDF(datiPerReport.calc_margine_disponibile_c557));
            checkPageBreak(lineHeight); doc.setFont(undefined, 'bold'); doc.text("Fase 4: Determinazione Spazio Utilizzabile Lordo", margin, yPosition); yPosition += lineHeight; doc.setFont(undefined, 'normal');
            addDataRow("Spazio Utilizzabile Lordo:", formatCurrencyPDF(datiPerReport.calc_spazio_utilizzabile_lordo));
            checkPageBreak(lineHeight); doc.setFont(undefined, 'bold'); doc.text("Fase 5: Calcolo Incremento Netto Effettivo del Fondo", margin, yPosition); yPosition += lineHeight; doc.setFont(undefined, 'normal');
            addDataRow("Incremento Netto Effettivo del Fondo:", formatCurrencyPDF(datiPerReport.calc_incremento_netto_fondo), true);

            addSectionTitle("Verifica Condizioni Normative Generali");
            addListItem(`Ente in prima fascia di virtuosità: ${datiPerReport.check_ente_virtuoso}`);
            addListItem(`Rispetto limiti spesa L. 296/06: ${datiPerReport.check_rispetto_limiti_spesa_generale}`);
            addListItem(`Equilibrio bilancio asseverato: ${datiPerReport.check_equilibrio_bilancio}`);
            
            checkPageBreak();
            if (datiPerReport.calc_incremento_finale_applicabile === "No" && datiPerReport.calc_incremento_netto_fondo > 0) {
                 doc.setFont(undefined, 'bold');
                 doc.text("ATTENZIONE: Nonostante un incremento netto positivo, alcune condizioni generali dichiarate NON rispettate potrebbero precludere l'applicazione.", margin, yPosition, {maxWidth: usableWidth});
                 yPosition += lineHeight * (doc.splitTextToSize("ATTENZIONE: Nonostante un incremento netto positivo, alcune condizioni generali dichiarate NON rispettate potrebbero precludere l'applicazione.", usableWidth).length);
                 doc.setFont(undefined, 'normal');
            } else if (datiPerReport.calc_incremento_netto_fondo <= 0) {
                 doc.setFont(undefined, 'bold');
                 doc.text("Non ci sono margini per un incremento netto del fondo.", margin, yPosition, {maxWidth: usableWidth});
                 yPosition += lineHeight;
                 doc.setFont(undefined, 'normal');
            }
            
            doc.save(`report_calcolo_${datiPerReport.nome_ente_calcolo.replace(/\s+/g, '_') || 'ente'}.pdf`);
            if (dataLoadingStatusDiv) dataLoadingStatusDiv.style.display = 'none';
        }


        function handleExportToCSV() {
            if (!datiPerReport || Object.keys(datiPerReport).length === 0) {
                alert("Nessun dato da esportare. Effettuare prima un calcolo.");
                return;
            }

            const headers = [
                "Nome Ente Calcolo", "Numero Abitanti Calcolo", "Num. Dipendenti Fondo 2025", "Provincia Selezionata", "Comune Selezionato", "Soglia % DL34 Calcolata",
                "Input: Stipendi Tab. 2023", "Input: Fondo Stabile 2023", "Input: Risorse PO/EQ 2023",
                "Input: Spesa Personale Cons.", "Input: Entrate Correnti Cons.", 
                "Input: Tetto Spesa c.557", "Input: Costo Assunzioni PIAO", "Input: % Oneri",
                "Calc: Incremento Potenziale 48%", "Calc: Spazio Disp. DL34", "Calc: Margine Disp. c.557",
                "Calc: Spazio Utilizzabile Lordo", "Calc: Incremento Netto Fondo",
                "Check: Ente Virtuoso?", "Check: Rispetto Limiti Spesa Gen.?", "Check: Equilibrio Bilancio?",
                "Finale: Incremento Applicabile?"
            ];

            const dataRows = [
                [
                    datiPerReport.nome_ente_calcolo,
                    datiPerReport.numero_abitanti_calcolo,
                    datiPerReport.num_dipendenti_fondo_2025,
                    datiPerReport.provincia_selezionata,
                    datiPerReport.comune_selezionato,
                    datiPerReport.input_soglia_perc_dl34_calcolata,
                    datiPerReport.input_stipendi_tabellari_2023,
                    datiPerReport.input_componente_stabile_fondo_2023,
                    datiPerReport.input_risorse_po_eq_2023,
                    datiPerReport.input_spesa_personale_consuntivo,
                    datiPerReport.input_entrate_correnti_consuntivo,
                    datiPerReport.input_tetto_spesa_c557,
                    datiPerReport.input_costo_assunzioni_piao,
                    (datiPerReport.input_perc_oneri_incremento * 100).toFixed(2) + '%',
                    datiPerReport.calc_incremento_potenziale_48,
                    datiPerReport.calc_spazio_disponibile_dl34,
                    datiPerReport.calc_margine_disponibile_c557,
                    datiPerReport.calc_spazio_utilizzabile_lordo,
                    datiPerReport.calc_incremento_netto_fondo,
                    datiPerReport.check_ente_virtuoso,
                    datiPerReport.check_rispetto_limiti_spesa_generale,
                    datiPerReport.check_equilibrio_bilancio,
                    datiPerReport.calc_incremento_finale_applicabile
                ]
            ];

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += headers.join(";") + "\r\n"; 

            dataRows.forEach(function(rowArray) {
                let row = rowArray.map(item => {
                    let cell = String(item === null || item === undefined ? '' : item);
                    if (cell.includes(';') || cell.includes('"') || cell.includes('\n')) {
                        cell = '"' + cell.replace(/"/g, '""') + '"';
                    }
                    if (typeof item === 'number') {
                        cell = String(item).replace('.', ',');
                    }
                    return cell;
                }).join(";");
                csvContent += row + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `calcolo_fondo_${datiPerReport.nome_ente_calcolo.replace(/\s+/g, '_') || 'ente'}.csv`);
            document.body.appendChild(link); 
            link.click();
            document.body.removeChild(link);
        }
        
        function generateTextReportForEmail() {
            if (!datiPerReport || Object.keys(datiPerReport).length === 0) {
                return "Nessun dato da inviare.";
            }
            const formatCurrency = (num) => typeof num === 'number' ? num.toLocaleString('it-IT', { style: 'currency', currency: 'EUR' }) : (num || 'N/D');
            const formatPercentage = (num) => typeof num === 'number' ? (num * 100).toFixed(2) + '%' : (num || 'N/D');
            const formatNumber = (num) => typeof num === 'number' ? num.toLocaleString('it-IT') : (num || 'N/D');
            const nl = '\n'; // Newline character
            let text = `RISULTATI DEL CALCOLO DETTAGLIATO PER: ${datiPerReport.nome_ente_calcolo || 'N/D'}${nl}`;
            text += `Numero Abitanti Utilizzato: ${formatNumber(datiPerReport.numero_abitanti_calcolo)}${nl}`;
            text += `--------------------------------------------------${nl}`;
            text += `FASE 1: INCREMENTO POTENZIALE MASSIMO (REGOLA DEL 48%)${nl}`;
            text += `Incremento Potenziale Lordo: ${formatCurrency(datiPerReport.calc_incremento_potenziale_48)}${nl}${nl}`;
            text += `FASE 2: VERIFICA LIMITE CAPACITÀ ASSUNZIONALE (DL 34/2019)${nl}`;
            text += `Spazio Disponibile (Limite DL34): ${formatCurrency(datiPerReport.calc_spazio_disponibile_dl34)}${nl}${nl}`;
            text += `FASE 3: VERIFICA LIMITE TETTO STORICO (L. 296/06 c.557)${nl}`;
            text += `Margine Disponibile (Limite c.557): ${formatCurrency(datiPerReport.calc_margine_disponibile_c557)}${nl}${nl}`;
            text += `FASE 4: DETERMINAZIONE SPAZIO UTILIZZABILE LORDO${nl}`;
            text += `Spazio Utilizzabile Lordo: ${formatCurrency(datiPerReport.calc_spazio_utilizzabile_lordo)}${nl}${nl}`;
            text += `FASE 5: CALCOLO INCREMENTO NETTO EFFETTIVO DEL FONDO${nl}`;
            text += `INCREMENTO NETTO EFFETTIVO DEL FONDO: ${formatCurrency(datiPerReport.calc_incremento_netto_fondo)}${nl}`;
            return text;
        }

        function handleInviaEmail() {
            if (!datiPerReport || Object.keys(datiPerReport).length === 0) {
                alert("Nessun dato da inviare via email. Effettuare prima un calcolo.");
                return;
            }
            const emailBodyText = generateTextReportForEmail();
            const subject = `Report Calcolo Fondo per ${datiPerReport.nome_ente_calcolo || 'Ente non specificato'}`;
            
            const mailtoLink = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(emailBodyText)}`;

            // L'avviso sulla lunghezza non è più necessario se il testo è breve, ma lo lascio commentato per riferimento.
            // if (mailtoLink.length > 2000) { 
            //     alert("Il report è troppo lungo per essere inviato completamente via email con questo metodo. Considerare l'esportazione PDF o CSV.");
            // }
            window.location.href = mailtoLink;
        }

    </script>
</body>
</html>
